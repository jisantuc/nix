ENV = SGML_CATALOG_FILES=$(docbookcatalog)

XMLLINT = $(ENV) $(xmllint) $(xmlflags) --catalogs
XSLTPROC = $(ENV) $(xsltproc) $(xmlflags) --catalogs \
 --param section.autolabel 1 \
 --param section.label.includes.component.label 1 \
 --param html.stylesheet \'style.css\'

SOURCES = book.xml introduction.xml installation.xml overview.xml \
 common-options.xml nix-store.xml nix-instantiate.xml \
 troubleshooting.xml bugs.xml \
 style.css

book.is-valid: $(SOURCES)
	$(XMLLINT) --noout --valid book.xml
	touch $@

man1_MANS = nix-store.1 nix-instantiate.1

man $(MANS): $(SOURCES) book.is-valid
	$(XSLTPROC) $(docbookxsl)/manpages/docbook.xsl book.xml

book.html: $(SOURCES) book.is-valid images
	$(XSLTPROC) --output book.html $(docbookxsl)/html/docbook.xsl book.xml

all-local: book.html

install-data-local: book.html
	$(INSTALL) -d $(DESTDIR)$(datadir)/nix/manual
	$(INSTALL_DATA) book.html $(DESTDIR)$(datadir)/nix/manual
	$(INSTALL_DATA) style.css $(DESTDIR)$(datadir)/nix/manual
	cp -r images $(DESTDIR)$(datadir)/nix/manual/images

images:
	mkdir images
	cp $(docbookxsl)/images/*.png images
	mkdir images/callouts
	cp $(docbookxsl)/images/callouts/*.png images/callouts
	chmod +w -R images

EXTRA_DIST = $(SOURCES) book.html book.is-valid $(MANS) 

DISTCLEANFILES = book.html book.is-valid $(MANS)
